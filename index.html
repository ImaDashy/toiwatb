<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Serial E-Book</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #333;
            background-color: #f0ece3;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .book-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            position: relative;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 5px;
            margin: 20px auto;
        }
        
        .book {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .page-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-out;
            overflow: hidden;
            background: white;
        }
        
        .page {
            width: 100%;
            height: 100%;
            padding: 40px;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Cover styling */
        .cover {
            position: relative;
            height: 100%;
            overflow: hidden;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 50px;
        }
        
        .cover-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .cover-content {
            position: relative;
            z-index: 2;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            width: 100%;
        }
        
        .cover h1 {
            font-family: 'Palatino', serif;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .cover h2 {
            font-family: 'Palatino', serif;
            font-size: 1.8em;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .turn-indicator {
            position: absolute;
            bottom: 30px;
            font-size: 1.2em;
            color: rgba(255,255,255,0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        /* Content styling */
        .content h1 {
            font-family: 'Palatino', serif;
            font-size: 2.2em;
            color: #444;
            margin-bottom: 30px;
        }
        
        .content h2 {
            font-family: 'Palatino', serif;
            color: #444;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5em;
        }
        
        .content p {
            margin-bottom: 1.2em;
            text-align: justify;
        }
        
        .content a {
            color: #0066cc;
            text-decoration: none;
            border-bottom: 1px dotted #0066cc;
        }
        
        .content a:hover {
            color: #004080;
            border-bottom: 1px solid #004080;
        }
        
        .page-number {
            padding: 15px 0;
            margin-top: auto;
            font-size: 0.9em;
            color: #888;
            text-align: center;
        }
        
        .turn-page-hint {
            position: fixed;
            bottom: 20px;
            color: #777;
            font-style: italic;
            font-size: 0.9em;
            animation: pulse 2s infinite;
            background: rgba(255,255,255,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .turn-page-hint.right {
            right: 20px;
        }
        
        .turn-page-hint.left {
            left: 20px;
        }
        
        /* Bottom of page footnote styling */
        .footnote-ref {
            font-size: 0.7em;
            vertical-align: super;
            color: #0066cc;
            cursor: pointer;
            margin-left: 1px;
            text-decoration: none;
        }
        
        .footnotes-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            color: #555;
            max-height: 40%;
            overflow: hidden;
        }
        
        .footnotes-section h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            font-style: italic;
            color: #666;
        }
        
        .footnote-item {
            display: flex;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .footnote-number {
            min-width: 25px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .footnote-content {
            flex: 1;
        }
        
        .footnote-content a {
            color: #0066cc;
            text-decoration: none;
            border-bottom: 1px dotted #0066cc;
        }
        
        .footnote-content a:hover {
            color: #004080;
            border-bottom: 1px solid #004080;
        }
        
        /* Main content area */
        .page-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 75%;
        }
        
        /* Navigation arrows */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            color: rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            transition: color 0.3s;
            user-select: none;
            background-color: rgba(255,255,255,0.4);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-arrow:hover {
            color: rgba(0,0,0,0.5);
            background-color: rgba(255,255,255,0.6);
        }
        
        .nav-arrow.prev {
            left: 10px;
        }
        
        .nav-arrow.next {
            right: 10px;
        }
        
        /* Click area styles */
        .nav-click-area {
            position: absolute;
            top: 0;
            height: 100%;
            width: 40%;
            z-index: 90;
            cursor: pointer;
        }
        
        .nav-click-area.left {
            left: 0;
        }
        
        .nav-click-area.right {
            right: 0;
        }
        
        /* TOC panel */
        .toc-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .toc-panel.collapsed {
            width: 40px;
            height: 40px;
            overflow: hidden;
        }
        
        .toc-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .toc-list {
            list-style-type: none;
            margin-top: 10px;
        }
        
        .toc-list li {
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .toc-list li:hover {
            background-color: #f0f0f0;
        }
        
        .toc-list li.current {
            font-weight: bold;
            color: #0066cc;
        }
        
        .toc-list .new-badge {
            background-color: #ff6b6b;
            color: white;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        /* Reading progress */
        .reading-progress {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .resume-button {
            display: block;
            width: 100%;
            padding: 8px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .resume-button:hover {
            background-color: #004d99;
        }
        
        /* For mobile */
        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .book-container {
                width: 100%;
                height: 100vh;
                max-height: none;
                margin: 0;
                border-radius: 0;
            }
            
            .page {
                padding: 20px;
                font-size: 16px;
            }
            
            .content h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            .content h2 {
                font-size: 1.5em;
                margin-top: 1.2em;
            }
            
            .content p {
                margin-bottom: 1em;
                line-height: 1.5;
            }
            
            .nav-arrow {
                font-size: 2em;
                width: 45px;
                height: 45px;
                top: auto;
                bottom: 20px;
                transform: none;
            }
            
            .nav-arrow.prev {
                left: 15px;
            }
            
            .nav-arrow.next {
                right: 15px;
            }
            
            .cover h1 {
                font-size: 2em;
            }
            
            .cover h2 {
                font-size: 1.4em;
            }
            
            .turn-page-hint {
                font-size: 0.8em;
                bottom: 10px;
            }
            
            .toc-panel {
                max-width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="book-container">
        <div class="book" id="book">
            <!-- Pages will be added here by JavaScript -->
        </div>
        
        <!-- Navigation Arrows -->
        <div class="nav-arrow prev" id="prev-btn">&#8249;</div>
        <div class="nav-arrow next" id="next-btn">&#8250;</div>
    </div>

    <!-- Table of Contents Panel -->
    <div class="toc-panel" id="toc-panel">
        <div class="toc-toggle" id="toc-toggle">≡</div>
        <h3>Table of Contents</h3>
        <ul class="toc-list" id="toc-list">
            <!-- Chapters will be added here by JavaScript -->
        </ul>
        <div class="reading-progress" id="reading-progress">
            <h4>Your Progress</h4>
            <p id="progress-info">No progress saved</p>
            <button class="resume-button" id="resume-button">Resume Reading</button>
        </div>
    </div>

    <script>
        // Book data URL - change this to point to your JSON file
        const BOOK_DATA_URL = 'book-data.json'; // You'll create this JSON file
        
        // Book data structure
        let bookData = {
            title: "Loading...",
            author: "Please wait",
            coverImage: "https://via.placeholder.com/800x1200",
            lastUpdated: "",
            chapters: []
        };
        
        // Reading state
        let currentPage = 0;
        let totalPages = 0;
        let currentChapter = 0;
        let userProgress = {
            lastChapter: 0,
            lastPage: 0,
            lastRead: null,
            readChapters: []
        };
        
        // Initialize the book
        document.addEventListener('DOMContentLoaded', function() {
            // Load user progress
            loadUserProgress();
            
            // Initialize UI controls
            initializeUIControls();
            
            // Fetch book data
            fetchBookData();
        });
        
        // Initialize UI controls
        function initializeUIControls() {
            // TOC panel toggle
            document.getElementById('toc-toggle').addEventListener('click', function() {
                document.getElementById('toc-panel').classList.toggle('collapsed');
            });
            
            // Resume reading button
            document.getElementById('resume-button').addEventListener('click', function() {
                resumeReading();
            });
            
            // Navigation buttons
            document.getElementById('prev-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                goToPreviousPage();
            });
            
            document.getElementById('next-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                goToNextPage();
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if(e.key === 'ArrowRight' || e.key === ' ') {
                    goToNextPage();
                } else if(e.key === 'ArrowLeft') {
                    goToPreviousPage();
                }
            });
            
            // Swipe navigation for mobile
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, false);
            
            function handleSwipe() {
                const swipeThreshold = 50;
                if(touchEndX < touchStartX - swipeThreshold) {
                    // Swipe left - go forward
                    goToNextPage();
                }
                if(touchEndX > touchStartX + swipeThreshold) {
                    // Swipe right - go back
                    goToPreviousPage();
                }
            }
        }
        
        // Fetch book data from JSON file
        function fetchBookData() {
            fetch(BOOK_DATA_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    bookData = data;
                    initializeBook();
                    checkForNewChapters();
                })
                .catch(error => {
                    console.error('Error fetching book data:', error);
                    // Fallback to demo data if fetch fails
                    loadDemoData();
                });
        }
        
        // Load demo data if JSON fetch fails
        function loadDemoData() {
            bookData = {
                title: "Serial E-Book Demo",
                author: "Demo Author",
                coverImage: "https://via.placeholder.com/800x1200",
                lastUpdated: new Date().toISOString(),
                chapters: [
                    {
                        number: 1,
                        title: "Introduction",
                        publishDate: new Date().toISOString(),
                        content: "# Introduction\n\nThis is a sample chapter for the serial e-book demo. In a real implementation, you would load chapters from a JSON file.\n\nYou can include **bold text**, *italic text*, and [links](https://example.com).\n\nThis paragraph includes a footnote reference[^1]. And here's another one with a longer explanation[^2].\n\n## A Subheading\n\nMore content goes here. You can add as much text as needed, and it will be automatically paginated with footnotes at the bottom of each page. The system will ensure that each page fits exactly within the viewport without requiring scrolling.\n\nEach paragraph will be carefully placed on the appropriate page, with footnotes always visible at the bottom. If a paragraph would extend beyond the available space, it will be moved to the next page.\n\nThis allows for a reading experience similar to a Kindle, where each page is exactly one screen of content, and the reader simply flips from one page to the next without ever needing to scroll.",
                        footnotes: [
                            { id: "1", text: "This is the first footnote. It can contain <a href='https://example.com'>links</a> and basic formatting." },
                            { id: "2", text: "This is the second footnote, which is longer to demonstrate how longer footnotes are handled. It might contain multiple sentences and explain a complex concept in detail. It can also contain <a href='https://example.com/resource'>links to additional resources</a> for readers who want to explore a topic further." }
                        ]
                    },
                    {
                        number: 2,
                        title: "Getting Started",
                        publishDate: new Date().toISOString(),
                        content: "# Getting Started\n\nThis is the second chapter of the demo e-book.\n\nYou'll need to create a JSON file similar to this demo data structure to provide real content for your serial publication.\n\nEach week, you can update the JSON file with a new chapter. Here's a reference with a footnote[^1].\n\n## Another Section\n\nThe footnotes will appear at the bottom of each page, not inline. They can contain links and formatting.\n\nMore paragraphs to demonstrate pagination. This content will be split into multiple pages as needed to ensure that everything fits on the screen without scrolling.\n\nEach page will have its own set of footnotes that are referenced on that page. This creates a clean reading experience where all needed information is visible at once.\n\nUsers can simply swipe or tap to move between pages, without having to scroll up and down.",
                        footnotes: [
                            { id: "1", text: "Footnotes will be placed at the bottom of each page, not inline. They can contain links and formatting." }
                        ]
                    }
                ]
            };
            initializeBook();
        }
        
        // Initialize the book with data
        function initializeBook() {
            const book = document.getElementById('book');
            book.innerHTML = '';
            
            // Create cover page
            createCoverPage();
            
            // Create TOC page
            createTOCPage();
            
            // Create chapter pages
            for(let i = 0; i < bookData.chapters.length; i++) {
                createChapterPages(bookData.chapters[i], i);
            }
            
            // Update total pages
            totalPages = document.querySelectorAll('.page-wrapper').length;
            
            // Initialize navigation
            updateNavigation();
            
            // Update TOC list
            updateTOCList();
            
            // Show resume button if there's saved progress
            updateProgressDisplay();
        }
        
        // Create cover page
        function createCoverPage() {
            const book = document.getElementById('book');
            
            const coverWrapper = document.createElement('div');
            coverWrapper.className = 'page-wrapper';
            coverWrapper.id = 'cover-wrapper';
            
            coverWrapper.innerHTML = `
                <div class="page cover">
                    <img src="${bookData.coverImage}" alt="Book Cover" class="cover-image">
                    <div class="cover-content">
                        <h1>${bookData.title}</h1>
                        <h2>By ${bookData.author}</h2>
                    </div>
                    <div class="turn-indicator">Tap to open →</div>
                </div>
            `;
            
            // Add navigation click areas
            addNavigationAreas(coverWrapper);
            
            book.appendChild(coverWrapper);
        }
        
        // Create TOC page
        function createTOCPage() {
            const book = document.getElementById('book');
            
            const tocWrapper = document.createElement('div');
            tocWrapper.className = 'page-wrapper';
            tocWrapper.id = 'toc-wrapper';
            tocWrapper.style.display = 'none';
            
            let tocHTML = `
                <div class="page content">
                    <div class="page-content">
                        <h1>Table of Contents</h1>
                        <ul style="list-style-type:none; margin-left:20px; line-height:1.8">
            `;
            
            for(let i = 0; i < bookData.chapters.length; i++) {
                const publishDate = new Date(bookData.chapters[i].publishDate).toLocaleDateString();
                tocHTML += `<li><a href="#" class="toc-link" data-chapter="${i}">Chapter ${bookData.chapters[i].number}: ${bookData.chapters[i].title}</a> <span style="color: #777; font-size: 0.8em;">(${publishDate})</span></li>`;
            }
            
            tocHTML += `
                        </ul>
                    </div>
                    <div class="page-number">Page ii</div>
                </div>
            `;
            
            tocWrapper.innerHTML = tocHTML;
            
            // Add navigation click areas
            addNavigationAreas(tocWrapper);
            
            book.appendChild(tocWrapper);
            
            // Add event listeners for TOC links
            setTimeout(() => {
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const chapterIndex = parseInt(this.getAttribute('data-chapter'));
                        goToChapter(chapterIndex);
                    });
                });
            }, 0);
        }
        
        // Create pages for a chapter
        function createChapterPages(chapter, chapterIndex) {
            const book = document.getElementById('book');
            const content = chapter.content;
            
            // Parse and paginate content with footnotes at bottom
            const pages = paginateContentWithFootnotes(content, chapter.footnotes, {
                chapterNumber: chapter.number,
                chapterTitle: chapter.title
            });
            
            // Create a page wrapper for each content page
            for(let i = 0; i < pages.length; i++) {
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'page-wrapper';
                pageWrapper.id = `chapter-${chapterIndex}-page-${i}-wrapper`;
                pageWrapper.setAttribute('data-chapter', chapterIndex);
                pageWrapper.setAttribute('data-page', i);
                pageWrapper.style.display = 'none';
                
                pageWrapper.innerHTML = `
                    <div class="page content">
                        ${pages[i]}
                    </div>
                `;
                
                // Add navigation click areas
                addNavigationAreas(pageWrapper);
                
                book.appendChild(pageWrapper);
            }
        }
        
        // Add navigation click areas to a page wrapper
        function addNavigationAreas(pageWrapper) {
            const leftNav = document.createElement('div');
            leftNav.className = 'nav-click-area left';
            leftNav.setAttribute('data-direction', 'prev');
            leftNav.addEventListener('click', function(e) {
                e.stopPropagation();
                goToPreviousPage();
            });
            
            const rightNav = document.createElement('div');
            rightNav.className = 'nav-click-area right';
            rightNav.setAttribute('data-direction', 'next');
            rightNav.addEventListener('click', function(e) {
                e.stopPropagation();
                goToNextPage();
            });
            
            pageWrapper.appendChild(leftNav);
            pageWrapper.appendChild(rightNav);
        }
        
        // Paginate content with footnotes at the bottom - much more conservative page sizing
        function paginateContentWithFootnotes(content, allFootnotes, options) {
            const settings = {
                chapterNumber: options.chapterNumber || 1,
                chapterTitle: options.chapterTitle || 'Chapter',
                // Much smaller word count per page to ensure everything fits
                wordsPerPage: 120 // Smaller count to fit everything on one screen
            };
            
            // Clean and split the content into paragraphs
            const paragraphs = content.trim().split(/\n\n+/);
            
            // Array to hold all pages
            const pages = [];
            
            // Current page data
            let currentPage = {
                content: [],
                footnotes: [],
                wordCount: 0
            };
            
            // Add chapter title to first page
            currentPage.content.push(`<h1>${settings.chapterTitle}</h1>`);
            
            // Process each paragraph
            for(let i = 0; i < paragraphs.length; i++) {
                const paragraph = paragraphs[i].trim();
                if(!paragraph) continue;
                
                // Format paragraph based on markdown and collect footnotes for this paragraph
                const { formattedText, footnoteRefs } = formatParagraphWithFootnotes(paragraph, allFootnotes);
                
                // Count words in this paragraph
                const words = paragraph.split(/\s+/).length;
                
                // Estimate space needed for footnotes (each footnote takes roughly 30 words worth of space)
                const footnoteSpace = footnoteRefs.length * 35;
                
                // Check if adding this paragraph would exceed the page limit
                if((currentPage.wordCount + words + footnoteSpace) > settings.wordsPerPage && currentPage.content.length > 0) {
                    // Create the page with its footnotes
                    pages.push(createPageWithFootnotes(currentPage, pages.length + 1));
                    
                    // Start a new page
                    currentPage = {
                        content: [formattedText],
                        footnotes: [...footnoteRefs],
                        wordCount: words
                    };
                } else {
                    // Add to current page
                    currentPage.content.push(formattedText);
                    currentPage.footnotes.push(...footnoteRefs);
                    currentPage.wordCount += words;
                }
            }
            
            // Add the last page
            if(currentPage.content.length > 0) {
                pages.push(createPageWithFootnotes(currentPage, pages.length + 1));
            }
            
            return pages;
        }
        
        // Format a paragraph with footnote references
        function formatParagraphWithFootnotes(paragraph, allFootnotes) {
            let formattedText = '';
            const footnoteRefs = [];
            
            if(paragraph.startsWith('#')) {
                // Heading
                const level = (paragraph.match(/^#+/) || [''])[0].length;
                const headingText = paragraph.replace(/^#+\s*/, '');
                formattedText = `<h${Math.min(level, 6)}>${headingText}</h${Math.min(level, 6)}>`;
            } else if(paragraph.startsWith('> ')) {
                // Blockquote
                const quoteText = paragraph.replace(/^>\s*/, '');
                formattedText = `<blockquote>${quoteText}</blockquote>`;
            } else if(paragraph.startsWith('- ') || paragraph.startsWith('* ')) {
                // Unordered list
                const listItems = paragraph.split(/\n- |\n\* /).map(item => item.replace(/^- |^\* /, '').trim());
                formattedText = '<ul>' + listItems.map(item => `<li>${item}</li>`).join('') + '</ul>';
            } else if(/^\d+\.\s/.test(paragraph)) {
                // Ordered list
                const listItems = paragraph.split(/\n\d+\.\s/).map(item => item.replace(/^\d+\.\s/, '').trim());
                formattedText = '<ol>' + listItems.map(item => `<li>${item}</li>`).join('') + '</ol>';
            } else {
                // Regular paragraph - check for footnotes and links
                let processedText = paragraph;
                
                // Replace footnote references: [^1] -> <sup class="footnote-ref" id="ref1">1</sup>
                processedText = processedText.replace(/\[\^(\d+)\]/g, (match, id) => {
                    // Find this footnote in the full list
                    const footnote = allFootnotes.find(fn => fn.id === id);
                    if(footnote) {
                        footnoteRefs.push(footnote);
                        return `<sup class="footnote-ref" id="ref${id}">${id}</sup>`;
                    }
                    return match;
                });
                
                // Replace markdown links: [text](url) -> <a href="url" target="_blank">text</a>
                processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                // Replace emphasis: *text* -> <em>text</em>
                processedText = processedText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
// Replace strong: **text** -> <strong>text</strong>
                processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                formattedText = `<p>${processedText}</p>`;
            }
            
            return { formattedText, footnoteRefs };
        }
        
        // Create a page with footnotes at the bottom
        function createPageWithFootnotes(pageData, pageNumber) {
            let pageHTML = `
                <div class="page-content">
                    ${pageData.content.join('')}
                </div>
            `;
            
            // Add footnotes section if there are any footnotes
            if(pageData.footnotes.length > 0) {
                pageHTML += `
                    <div class="footnotes-section">
                        <h4>Notes</h4>
                `;
                
                // Add each footnote
                for(let footnote of pageData.footnotes) {
                    pageHTML += `
                        <div class="footnote-item">
                            <div class="footnote-number">${footnote.id}.</div>
                            <div class="footnote-content">${footnote.text}</div>
                        </div>
                    `;
                }
                
                pageHTML += `</div>`;
            }
            
            // Add page number
            pageHTML += `
                <div class="page-number">Page ${pageNumber}</div>
            `;
            
            return pageHTML;
        }
        
        // Navigate to a specific page with animation
        function goToPage(pageIndex) {
            if(pageIndex < 0 || pageIndex >= totalPages) return;
            
            const pageWrappers = document.querySelectorAll('.page-wrapper');
            const currentWrapper = pageWrappers[currentPage];
            const targetWrapper = pageWrappers[pageIndex];
            
            // Define animation direction
            const direction = pageIndex > currentPage ? 'forward' : 'backward';
            
            // Begin animation
            if (direction === 'forward') {
                // Show target off-screen to the right
                targetWrapper.style.display = 'block';
                targetWrapper.style.transform = 'translateX(100%)';
                
                // Animation timing
                requestAnimationFrame(() => {
                    // Slide current left and target to center
                    currentWrapper.style.transform = 'translateX(-100%)';
                    targetWrapper.style.transform = 'translateX(0)';
                    
                    setTimeout(() => {
                        // Hide previous page when animation completes
                        currentWrapper.style.display = 'none';
                        currentWrapper.style.transform = '';
                        currentPage = pageIndex;
                        updateNavigation();
                        updateCurrentChapter();
                        saveReadingProgress();
                    }, 500);
                });
            } else {
                // Show target off-screen to the left
                targetWrapper.style.display = 'block';
                targetWrapper.style.transform = 'translateX(-100%)';
                
                // Animation timing
                requestAnimationFrame(() => {
                    // Slide current right and target to center
                    currentWrapper.style.transform = 'translateX(100%)';
                    targetWrapper.style.transform = 'translateX(0)';
                    
                    setTimeout(() => {
                        // Hide previous page when animation completes
                        currentWrapper.style.display = 'none';
                        currentWrapper.style.transform = '';
                        currentPage = pageIndex;
                        updateNavigation();
                        updateCurrentChapter();
                        saveReadingProgress();
                    }, 500);
                });
            }
        }
        
        // Go to previous page
        function goToPreviousPage() {
            if(currentPage > 0) {
                goToPage(currentPage - 1);
            }
        }
        
        // Go to next page
        function goToNextPage() {
            if(currentPage < totalPages - 1) {
                goToPage(currentPage + 1);
            }
        }
        
        // Go to a specific chapter
        function goToChapter(chapterIndex) {
            if(chapterIndex < 0 || chapterIndex >= bookData.chapters.length) return;
            
            // Find the first page of the chapter
            const pageWrappers = document.querySelectorAll('.page-wrapper');
            
            for(let i = 0; i < pageWrappers.length; i++) {
                if(pageWrappers[i].getAttribute('data-chapter') == chapterIndex && 
                   pageWrappers[i].getAttribute('data-page') == 0) {
                    goToPage(i);
                    break;
                }
            }
            
            // Update current chapter
            currentChapter = chapterIndex;
            updateTOCList();
            
            // Mark chapter as read
            if (!userProgress.readChapters.includes(chapterIndex)) {
                userProgress.readChapters.push(chapterIndex);
                saveUserProgress();
            }
        }
        
        // Update navigation buttons
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.style.visibility = currentPage > 0 ? 'visible' : 'hidden';
            nextBtn.style.visibility = currentPage < totalPages - 1 ? 'visible' : 'hidden';
        }
        
        // Update current chapter based on current page
        function updateCurrentChapter() {
            const pageWrapper = document.querySelectorAll('.page-wrapper')[currentPage];
            if(pageWrapper && pageWrapper.hasAttribute('data-chapter')) {
                currentChapter = parseInt(pageWrapper.getAttribute('data-chapter'));
                updateTOCList();
            }
        }
        
        // Update TOC list highlighting
        function updateTOCList() {
            const tocList = document.getElementById('toc-list');
            tocList.innerHTML = '';
            
            for(let i = 0; i < bookData.chapters.length; i++) {
                const li = document.createElement('li');
                let liContent = `Chapter ${bookData.chapters[i].number}: ${bookData.chapters[i].title}`;
                
                // Add "New" badge for chapters published within the last 7 days
                const publishDate = new Date(bookData.chapters[i].publishDate);
                const now = new Date();
                const daysDiff = Math.floor((now - publishDate) / (1000 * 60 * 60 * 24));
                
                if(daysDiff < 7) {
                    liContent += ` <span class="new-badge">NEW</span>`;
                }
                
                li.innerHTML = liContent;
                li.addEventListener('click', function() {
                    goToChapter(i);
                });
                
                if(i === currentChapter) {
                    li.classList.add('current');
                }
                
                tocList.appendChild(li);
            }
        }
        
        // Save reading progress
        function saveReadingProgress() {
            const pageWrapper = document.querySelectorAll('.page-wrapper')[currentPage];
            if(!pageWrapper) return;
            
            if(pageWrapper.hasAttribute('data-chapter')) {
                userProgress.lastChapter = parseInt(pageWrapper.getAttribute('data-chapter'));
                userProgress.lastPage = currentPage;
                userProgress.lastRead = new Date().toISOString();
                
                // Mark chapter as read if not already
                if(!userProgress.readChapters.includes(userProgress.lastChapter)) {
                    userProgress.readChapters.push(userProgress.lastChapter);
                }
                
                saveUserProgress();
                updateProgressDisplay();
            }
        }
        
        // Load user progress from localStorage
        function loadUserProgress() {
            const savedProgress = localStorage.getItem('ebookProgress');
            if(savedProgress) {
                try {
                    userProgress = JSON.parse(savedProgress);
                } catch(e) {
                    console.error('Error loading user progress', e);
                }
            }
        }
        
        // Save user progress to localStorage
        function saveUserProgress() {
            localStorage.setItem('ebookProgress', JSON.stringify(userProgress));
        }
        
        // Update progress display
        function updateProgressDisplay() {
            const progressInfo = document.getElementById('progress-info');
            const resumeButton = document.getElementById('resume-button');
            
            if(userProgress.lastRead) {
                const lastReadDate = new Date(userProgress.lastRead).toLocaleDateString();
                const chapterInfo = userProgress.lastChapter >= 0 && userProgress.lastChapter < bookData.chapters.length
                    ? `Chapter ${bookData.chapters[userProgress.lastChapter].number}: ${bookData.chapters[userProgress.lastChapter].title}`
                    : 'Unknown chapter';
                
                progressInfo.textContent = `Last read: ${lastReadDate}
                ${chapterInfo}`;
                resumeButton.style.display = 'block';
            } else {
                progressInfo.textContent = 'No reading progress saved yet';
                resumeButton.style.display = 'none';
            }
        }
        
        // Resume reading from last position
        function resumeReading() {
            if(userProgress.lastPage > 0 && userProgress.lastPage < totalPages) {
                goToPage(userProgress.lastPage);
            } else if(userProgress.lastChapter >= 0 && userProgress.lastChapter < bookData.chapters.length) {
                goToChapter(userProgress.lastChapter);
            }
            
            // Close TOC panel
            document.getElementById('toc-panel').classList.add('collapsed');
        }
        
        // Check for new chapters
        function checkForNewChapters() {
            // If this is the first visit, don't show notification
            if(!userProgress.lastRead) return;
            
            const lastVisit = new Date(userProgress.lastRead);
            let newChapters = 0;
            
            // Count chapters published since last visit
            for(let i = 0; i < bookData.chapters.length; i++) {
                const chapterDate = new Date(bookData.chapters[i].publishDate);
                if(chapterDate > lastVisit && !userProgress.readChapters.includes(i)) {
                    newChapters++;
                }
            }
            
            // Show notification if there are new chapters
            if(newChapters > 0) {
                alert(`Welcome back! ${newChapters} new chapter${newChapters > 1 ? 's' : ''} have been added since your last visit.`);
            }
        }
// JSON Formatter Functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize JSON formatter
    const openFormatterBtn = document.getElementById('open-formatter-btn');
    const closeFormatterBtn = document.getElementById('close-formatter-btn');
    const formatJsonBtn = document.getElementById('format-json-btn');
    const copyJsonBtn = document.getElementById('copy-json-btn');
    const jsonFormatter = document.getElementById('json-formatter');
    
    // Open formatter
    if (openFormatterBtn) {
        openFormatterBtn.addEventListener('click', function() {
            jsonFormatter.style.display = 'block';
        });
    }
    
    // Close formatter
    if (closeFormatterBtn) {
        closeFormatterBtn.addEventListener('click', function() {
            jsonFormatter.style.display = 'none';
        });
    }
    
    // Format JSON
    if (formatJsonBtn) {
        formatJsonBtn.addEventListener('click', function() {
            const chapterTitle = document.getElementById('chapter-title-input').value;
            const chapterNumber = document.getElementById('chapter-number-input').value;
            const chapterText = document.getElementById('chapter-text-input').value;
            
            if (!chapterTitle || !chapterNumber || !chapterText) {
                alert('Please fill in all fields');
                return;
            }
            
            // Generate JSON for a new chapter
            const jsonOutput = createChapterJSON(chapterTitle, chapterNumber, chapterText);
            document.getElementById('formatted-json').value = jsonOutput;
        });
    }
    
    // Copy to clipboard
    if (copyJsonBtn) {
        copyJsonBtn.addEventListener('click', function() {
            const formattedJson = document.getElementById('formatted-json');
            formattedJson.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = copyJsonBtn.textContent;
            copyJsonBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyJsonBtn.textContent = originalText;
            }, 2000);
        });
    }
    
    // Utility function to create chapter JSON
    function createChapterJSON(title, number, text) {
        // Create a chapter object
        const chapter = {
            number: parseInt(number),
            title: title,
            publishDate: new Date().toISOString(),
            content: text,
            footnotes: []
        };
        
        // Format it nicely
        return JSON.stringify(chapter, null, 2);
    }
    
    // Function to update existing book JSON
    function updateBookJSON(newChapter) {
        // Assuming bookData is your global book data
        if (typeof bookData !== 'undefined') {
            // Check if chapter with this number already exists
            const existingIndex = bookData.chapters.findIndex(ch => ch.number === newChapter.number);
            
            if (existingIndex >= 0) {
                // Update existing chapter
                bookData.chapters[existingIndex] = newChapter;
            } else {
                // Add new chapter
                bookData.chapters.push(newChapter);
                // Sort chapters by number
                bookData.chapters.sort((a, b) => a.number - b.number);
            }
            
            // Update lastUpdated field
            bookData.lastUpdated = new Date().toISOString();
            
            // Return formatted book data
            return JSON.stringify(bookData, null, 2);
        }
        
        return null;
    }
});
    </script>

<!-- JSON Formatter Tool -->
<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 2000; display: none; width: 90%; max-width: 600px;" id="json-formatter">
    <h3>Chapter JSON Formatter</h3>
    <div>
        <label for="chapter-title-input">Chapter Title:</label>
        <input type="text" id="chapter-title-input" style="width: 100%; margin-bottom: 10px; padding: 5px;">
    </div>
    <div>
        <label for="chapter-number-input">Chapter Number:</label>
        <input type="number" id="chapter-number-input" style="width: 100%; margin-bottom: 10px; padding: 5px;" value="1">
    </div>
    <div>
        <label for="chapter-text-input">Paste Chapter Text:</label>
        <textarea id="chapter-text-input" style="width: 100%; height: 200px; margin-bottom: 10px; padding: 5px; font-family: monospace;"></textarea>
    </div>
    <div>
        <label for="formatted-json">Formatted JSON (Copy this to your JSON file):</label>
        <textarea id="formatted-json" style="width: 100%; height: 200px; margin-bottom: 10px; padding: 5px; font-family: monospace;" readonly></textarea>
    </div>
    <div>
        <button id="format-json-btn" style="padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">Format</button>
        <button id="copy-json-btn" style="padding: 8px 16px; background: #009933; color: white; border: none; border-radius: 4px; margin-left: 10px; cursor: pointer;">Copy to Clipboard</button>
        <button id="close-formatter-btn" style="padding: 8px 16px; margin-left: 10px; cursor: pointer;">Close</button>
    </div>
</div>

<!-- Button to open the formatter -->
<button id="open-formatter-btn" style="position: fixed; bottom: 10px; right: 10px; padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 4px; z-index: 1000; cursor: pointer;">Format Chapter</button>
</body>
</html>
